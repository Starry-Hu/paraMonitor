<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="css/layui.css">
    <link rel="stylesheet" type="text/css" href="css/layui.mobile.css">
    <link rel="stylesheet" href="css/style.css">
    <title>设备列表获取</title>
    <style>
        .layui-badge-rim {
            height: 24px;
            line-height: 24px;
        }
        
        #idName {
            height: 4rem;
            line-height: 4rem;
        }
    </style>
</head>

<body>
    <p>
        <a class="layui-btn layui-btn-primary" href="#">
            < 返回 </a>
    </p>
    <div id="main" class="layui-fluid">
        <div class="layui-row">
            <p id="title" class="layui-col-xs12">
                <button class="layui-btn layui-btn-radius layui-btn-primary textACenter">
                                设备查看详情
                    </button>
            </p>
            <p id="idName" class="layui-col-xs12">
                <span class="layui-badge-rim">设备号：1435066367</span>
                <span class="layui-badge-rim">设备名：ra-device</span>
            </p>

        </div>
        <!-- 设备信息 -->
        <div class="layui-row">
            <div class="layui-col-xs12">
                <table id="deviceInfo" class="layui-table" lay-skin="line" style="margin-bottom: 1.5rem;">
                    <colgroup>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th>设备号</th>
                            <th>设备名</th>
                            <th>数据项名称</th>
                            <th>数据类型名称</th>
                            <th>驱动名称</th>
                            <th>数据采集频率(ms)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                    </tbody>
                </table>
            </div>
        </div>
        <!-- 告警信息 -->
        <div class="layui-row">
            <div class="layui-col-xs12">
                <button class="layui-btn layui-btn-radius layui-btn-warm textACenter" style="color:#000">
                    告警信息
                </button>
                <textarea id="alarmInfo" class="layui-textarea" readonly></textarea>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-xs12">
                <button class="layui-btn layui-btn-radius layui-btn-warm textACenter" style="color:#000">
                    告警信息
                </button>
                <textarea id="alarmInfo" class="layui-textarea" readonly></textarea>
            </div>
        </div>
    </div>

    <script src="js/jquery-3.3.1.js"></script>
    <script src="js/common.js"></script>
    <script>
        $(function() {
            var str = window.location.href;
            var deviceid = str.substr(str.indexOf('=') + 1);
            var tokenValue = cookie.get("tokenValue");

            if (tokenValue == '') {
                alert("您还未登录，请先登录");
                return;
            }

            /**
             * 动态渲染表格 - 显示设备所有参数列表（所有数据项）
             */
            $.ajax({
                type: "get",
                url: basePath + "/dataitemlist/getDataItemList",
                contentType: "application/json",
                dataType: "json",
                data: {
                    "token": tokenValue,
                    "hash": "test",
                    "deviceid": deviceid,
                },
                success: function(response) {
                    console.log(response)
                    if (response.status != '100') {
                        alert(response.msg);
                        return;
                    }

                    /**
                     * 测试样例（重构参数列表数组）
                     */
                    response.data = [];
                    for (let index = 0; index < 3; index++) {
                        var jsonString =
                            `{"devid":1435066367,"deviceName":"ra-device","itemid":"1","config":"","datatype":"a","datatypeName":"数值","driverid":29,"driverName":"libtremoteplc","did":0,"itemname":"CSQ","itemalias":null,"readonly":0,"frequency":120000,"dataAddress":null,"hex":null,"precision":null}`;
                        // 将上述字符串转成json
                        var obj = JSON.parse(jsonString);
                        // 添加到数组中
                        response.data.push(obj);
                    }

                    console.log(response.data)
                    for (let i = 0; i < response.data.length; i++) {
                        const element = response.data[i];

                        var $tr = $('<tr></tr>');
                        var $td1 = `<td data-label="设备号">${element.devid}</td>`;
                        var $td2 = `<td data-label="设备名">${element.deviceName}</td>`;
                        var $td3 = `<td data-label="数据项名称">${element.itemname}</td>`;
                        var $td4 = `<td data-label="数据项别名">${element.itemalias}</td>`;
                        if (element.itemalias == null) {
                            $td4 = `<td data-label="数据项别名">暂无记录</td>`;
                        }
                        var $td5 = `<td data-label="数据类型名称">${element.datatypeName}</td>`;
                        var $td6 = `<td data-label="驱动名称">${element.driverName}</td>`;
                        var $td7 =
                            `<td data-label="数据采集频率(ms)">${element.frequency}</td>`;
                        var $td8 = `<td><button class="layui-btn layui-btn-sm layui-btn-radius layui-btn-primary
                                        textACenter">可写</button> </td>`;
                        if (element.readonly == 0) {
                            $td8 = `<td><button
                                        class="layui-btn layui-btn-sm layui-btn-radius layui-btn-normal
                                        textACenter">只读</button> </td>`;
                        }

                        $tr.append($td1 + $td2 + $td3 + $td4 + $td5 + $td6 + $td7 + $td8);
                        $('#tbody').append($tr);
                    }
                }
            });

            // 获取设备的报警信息
            $.ajax({
                type: "get",
                url: basePath + "/alarm",
                contentType: "application/json",
                dataType: "json",
                data: {
                    "token": tokenValue,
                    "hash": "test",
                    "devid": deviceid,
                },
                success: function(response) {
                    console.log(response);
                    if (response.data.list.length == 0) {
                        $('#alarmInfo').val("暂无报警信息");
                    } else {
                        $('#alarmInfo').val("测试")
                    }
                }
            });

            // // 获取设备的实时数据
            // $.ajax({
            //     type: "get",
            //     url: basePath + "/currentdata",
            //     contentType: "application/json",
            //     dataType: "json",
            //     data: {
            //         "token": tokenValue,
            //         "hash": "test",
            //         "deviceid": deviceid,
            //     },
            //     success: function(response) {
            //         console.log(response);
            //         if (response.data.length == 0) {
            //             $('#alarmInfo').val("暂无报警信息");
            //         } else {
            //             $('#alarmInfo').val("测试")
            //         }
            //     }
            // });
        })
    </script>
</body>

</html>