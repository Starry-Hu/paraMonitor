<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="css/layui.css">
    <link rel="stylesheet" type="text/css" href="css/layui.mobile.css">
    <link rel="stylesheet" href="css/style.css">
    <title>设备具体数据项展示-数值</title>
    <style>
        .layui-badge-rim {
            height: 24px;
            line-height: 24px;
        }
        
        #idName {
            height: 4rem;
            line-height: 4rem;
        }
        
        #node1,
        #node2 {
            height: 400px;
        }
    </style>
</head>

<body>
    <p>
        <a class="layui-btn layui-btn-primary" href="javascript:history.back(-1)">
            < 返回 </a>
    </p>
    <div id="main" class="layui-fluid">
        <div class="layui-row">
            <p id="title" class="layui-col-xs12">
                <button class="layui-btn layui-btn-radius layui-btn-primary textACenter" id="titleBtn">
                            设备查看详情
                        </button>
            </p>
            <p id="idName" class="layui-col-xs12">
                <span class="layui-badge-rim">设备号：1435066367</span>
                <span class="layui-badge-rim">设备名：ra-device</span>
            </p>

        </div>
        <!-- 设备信息 -->
        <div class="layui-row">
            <div class="layui-col-xs12">
                <table id="deviceInfo" class="layui-table" lay-skin="line" style="margin-bottom: 1.5rem;">
                    <colgroup>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th>数据项id</th>
                            <th>数据项名称</th>
                            <th>数据类型</th>
                            <th>数值</th>
                            <th>采集时间</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                    </tbody>
                </table>
            </div>
        </div>
        <!-- 告警信息 -->
        <!-- <div class="layui-row">
            <div class="layui-col-xs12">
                <button class="layui-btn layui-btn-radius layui-btn-warm textACenter" style="color:#000">
                            告警信息
                        </button>
                <textarea id="alarmInfo" class="layui-textarea" readonly></textarea>
            </div>
        </div> -->

        <!-- <div class="layui-container"> -->
        <div id="node1"></div>
        <div id="node2"></div>
        <!-- </div> -->
    </div>

    <script src="js/jquery-3.3.1.js"></script>
    <script src="js/common.js"></script>
    <script src="js/echarts.min.js"></script>
    <script src="js/tableShowInVal.js"></script>

    <script>
        $(function() {
            var deviceid = getQueryString("deviceid");
            var itemid = getQueryString("itemid");
            var itemname = getQueryString("itemname");
            var tokenValue = cookie.get("tokenValue");

            var errorItem = []; // 引发报警的数据项



            if (tokenValue == undefined) {
                alert("您还未登录，请先登录");
                window.location.href = "login.html"
            }


            /**
             * 获取该设备此参数的实时数据(渲染在表格中)
             * - 测试时出错- 后台返回格式不佳，解析错误
             */
            $.ajax({
                type: "get",
                url: basePath + "/currentdata",
                contentType: "application/json",
                dataType: "json",
                data: {
                    "token": tokenValue,
                    "hash": "test",
                    "deviceid": deviceid,
                    "itemids": itemid,
                },
                success: function(response) {
                    console.log(response);
                    if (response.status != 100) {
                        alert(response.msg);
                        return;
                    }
                    if (response.data.length == 0) {
                        $('#alarmInfo').val("暂无实时数据");
                        // return;  // 测试时隐藏
                    }
                    // --- 测试样例，生成实时数据对象 ---
                    var testArray = [];
                    for (let index = 0; index < 1; index++) {
                        var jsonString =
                            `{"datatype":"a","datatypeName":"数值","devName":"ra-device","devid":"1435066367","htime":"2019-04-12 14:09:06.838","itemid":"1","itemname":"COOLING WATER TEM0.","quality":"b","readOnly":true,"timestamp":1555049346838,"val":"24"}`;
                        var test = JSON.parse(jsonString);
                        testArray.push(test);
                    }

                    response.data = testArray;

                    // 展示不同情况下的参数情况
                    const element = response.data[0];
                    var $tr = $('<tr> </tr>');
                    var $td1 = `<td data-label="数据项id" class=" layui-badge">${element.itemid}</td>`;
                    if (element.quality == "g") {
                        $td1 = `<td data-label="数据项id" class=" layui-badge layui-bg-green">${element.itemid}</td>`;
                    }

                    var $td2 = `<td data-label="数据项名称">${element.itemname}</td>`;
                    var $td3 = `<td data-label="数据类型">${element.datatypeName}</td>`;
                    var $td4 = `<td data-label="数值">${element.val}</td>`;
                    var $td5 = `<td data-label="采集时间">${element.htime}</td>`;
                    var $td6 = `<td><button class="layui-btn layui-btn-sm layui-btn-radius layui-btn-primary
                                        textACenter">可写</button> </td>`;
                    if (element.readOnly == true) {
                        $td6 = `<td><button class="layui-btn layui-btn-sm layui-btn-radius layui-btn-normal
                                        textACenter">只读</button> </td>`;
                    }
                    $tr.append($td1 + $td2 + $td3 + $td4 + $td5 + $td6);
                    $('#tbody').append($tr);
                    $('#titleBtn').text("参数查看详情：" + element.itemname);
                }
            });

            /**
             * 获取单个数据项的历史数据 （测试样例未配置历史信息）
             */

            $.ajax({
                type: "get",
                url: basePath + "/historydata",
                contentType: "application/json",
                dataType: "json",
                data: {
                    "token": tokenValue,
                    "hash": "test",
                    "deviceid": deviceid,
                    "dataitemid": itemid,
                },
                success: function(response) {
                    if (response.status != 100) {
                        alert(response.msg);
                        return;
                    }

                    // --- 测试样例，生成历史数据数组 ---
                    var testArray = [];
                    for (let index = 0; index < 5; index++) {
                        var jsonString = `{"alias":"COOLING WATER TEM0.",
                        "datatype":"a",
                        "datatypeName":"数值",
                        "devid":"1536008193",
                        "htime":"2019-04-12 1${index}:09:06.838", "itemid":"1",
                        "itemname":"COOLING WATER TEM0.",
                        "readOnly":true,
                        "val":"2${index}" }`;
                        var test = JSON.parse(jsonString);
                        testArray.push(test);
                    }
                    response.data = testArray;

                    // 获取历史数据的有用信息，放入oldData数组
                    var oldData = [];
                    for (let i = 0; i < response.data.length; i++) {
                        const element = response.data[i];
                        var oneData = [element.htime, element.val];
                        oldData.push(oneData);
                    }
                    drawOldNode(oldData);
                }
            })


            /**
             * 每隔一段时间获取一次实时数据，并且渲染在页面上 
             */
            $(document).ready(function() {
                var currentData = [];
                var testFlag = 0;
                setInterval(function() {
                    $.ajax({
                        type: "get",
                        url: basePath + "/currentdata",
                        contentType: "application/json",
                        dataType: "json",
                        data: {
                            "token": tokenValue,
                            "hash": "test",
                            "deviceid": deviceid,
                            "itemids": itemid,
                        },
                        success: function(response) {
                            if (response.status != 100) {
                                alert(response.msg);
                                return;
                            }
                            if (response.data.length == 0) {
                                $('#alarmInfo').val("暂无实时数据");
                                return;
                            }
                            // --- 测试样例，生成实时数据对象 ---
                            var testArray = [];
                            for (let index = 0; index < 1; index++) {
                                var date = new Date();
                                var timeStr = date.getHours + date.getMinutes + date.getSeconds;
                                var jsonString = `{"datatype":"a","datatypeName":"数值","devName":"ra-device","devid":"1435066367","htime":"1","itemid":"1","itemname":"COOLING WATER TEM0.","quality":"b","readOnly":true,"timestamp":1555049346838,"val":"${testFlag}"}`;
                                var test = JSON.parse(jsonString);
                                testArray.push(test);
                            }
                            response.data = testArray; // 展示不同情况下的参数情况
                            const element = response.data[0];
                            // 获取实时数据的有用信息，放入currentData数组

                            for (let i = 0; i < response.data.length; i++) {
                                const element = response.data[i];
                                var oneData = [element.htime, element.val];
                                currentData.push(oneData);
                            }
                        }
                    });
                    var chooseData = getTopSixData(currentData);
                    // console.log(chooseData)
                    drawCurrentNode(chooseData);
                    testFlag = testFlag + 0.01;
                    // check(obj);
                }, 1000);
            });
        })
    </script>
</body>

</html>